name: E2E Integration Testing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - user-flows
          - api-integration
          - cross-service
      browser:
        description: 'Browser to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit

jobs:
  e2e-integration:
    needs: [] # Can run independently or add dependencies as needed
    uses: satoshi-watanabe-0001/ahamo-dummy-demo2-e2e/.github/workflows/e2e-called.yaml@main
    with:
      ENV: 'e2e'
      TRIGGER_REPO: 'frontend'
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
      TEST_SUITE: ${{ inputs.test_suite || 'all' }}
      BROWSER: ${{ inputs.browser || 'all' }}
    secrets: inherit

  e2e-report:
    needs: e2e-integration
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Comment PR with E2E Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const results = '${{ needs.e2e-integration.outputs.TEST_RESULTS }}';
            const successRate = '${{ needs.e2e-integration.outputs.SUCCESS_RATE }}';

            const comment = `## ğŸ§ª ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ

            **æˆåŠŸç‡**: ${successRate}%
            **å®Ÿè¡Œç’°å¢ƒ**: e2e
            **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.head_ref || github.ref_name }}
            **ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ**: ${{ inputs.test_suite || 'all' }}
            **ãƒ–ãƒ©ã‚¦ã‚¶**: ${{ inputs.browser || 'all' }}

            è©³ç´°ãªçµæœã¯[Actionsã‚¿ãƒ–](${context.payload.repository.html_url}/actions/runs/${context.runId})ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

            ---
            *ã“ã®E2Eãƒ†ã‚¹ãƒˆã¯[ahamo-dummy-demo2-e2e](https://github.com/satoshi-watanabe-0001/ahamo-dummy-demo2-e2e)ãƒªãƒã‚¸ãƒˆãƒªã®å…±é€šãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§å®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Set E2E Test Status
        if: always()
        run: |
          if [[ "${{ needs.e2e-integration.result }}" == "success" ]]; then
            echo "âœ… E2Eãƒ†ã‚¹ãƒˆæˆåŠŸ"
            exit 0
          else
            echo "âŒ E2Eãƒ†ã‚¹ãƒˆå¤±æ•—"
            exit 1
          fi
